<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Receiving </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Receiving ">
    <meta name="generator" content="docfx 2.58.0.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/night-owl.min.css">
    <link rel="stylesheet" href="../../../styles/colors.css">
    <link rel="stylesheet" href="../../../styles/discord.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="../../../toc.html">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    <meta property="docfx:rel" content="../../../">
    
  </head>

  <body>
        <div class="top-navbar">

            <a href="javascript:void(0);" class="burger-icon" onclick="toggleMenu()">
                <svg name="Hamburger" style="vertical-align: middle;" width="24" height="24" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M20 6H4V9H20V6ZM4 10.999H20V13.999H4V10.999ZM4 15.999H20V18.999H4V15.999Z"></path></svg>
            </a>

            
            <a class="brand" href="../../../index.html">
              <img src="../../../logo.svg" alt="" class="logomark">
              <span class="brand-title"></span>
            </a>
        </div>

        <div class="body-content">

            <div id="blackout" class="blackout" onclick="toggleMenu()"></div>

            <nav id="sidebar" role="navigation">

                <div class="sidebar">
                    
                    
                    
                    
                    <div>
                      
                      <a class="brand" href="../../../index.html">
                        <img src="../../../logo.svg" alt="" class="logomark">
                        <span class="brand-title"></span>
                      </a>
                      <div id="navbar">
                    
                      </div>
                    
                    </div>


                    <div class="sidebar-item-separator"></div>

                        
                        <div id="sidetoggle">
                          <div id="sidetoc"></div>
                        </div>

                </div>

                <div class="footer">
                  © 2021 Aiko IT Systems
                  
                </div>
            </nav>

            <main class="main-panel">

                <div role="main" class="hide-when-search">

                        
                        <div class="subnav navbar navbar-default">
                          <div class="container hide-when-search" id="breadcrumb">
                            <ul class="breadcrumb">
                              <li></li>
                            </ul>
                          </div>
                        </div>

                    <article class="content wrap" id="_content" data-uid="voicenext_receive">
<h2 id="receiving-with-voicenext">Receiving with VoiceNext</h2>

<h3 id="enable-receiver">Enable Receiver</h3>
<p>Receiving incoming audio is disabled by default to save on bandwidth, as most users will never make use of incoming data.
This can be changed by providing a configuration object to <code>DiscordClient#UseVoiceNext()</code>.</p>
<pre><code class="lang-cs">var discord = new DiscordClient();

discord.UseVoiceNext(new VoiceNextConfiguration()
{
    EnableIncoming = true
});
</code></pre><h3 id="establish-connection">Establish Connection</h3>
<p>The voice channel join process is the exact same as when transmitting.</p>
<pre><code class="lang-cs">DiscordChannel channel;
VoiceNextConnection connection = await channel.ConnectAsync();
</code></pre><h3 id="write-event-handler">Write Event Handler</h3>
<p>We&#39;ll be able to receive incoming audio from the <code>VoiceReceived</code> event fired by <code>VoiceNextConnection</code>.</p>
<pre><code class="lang-cs">connection.VoiceReceived += ReceiveHandler;
</code></pre><p>Writing the logic for this event handler will depend on your overall goal. </p>
<p>The event arguments will contain a PCM audio packet for you to make use of.
You can convert each packet to another format, concatenate them all together, feed them into an external program, or process the packets any way that&#39;ll suit your needs.</p>
<p>When a user is speaking, <code>VoiceReceived</code> should fire once every twenty milliseconds and its packet will contain around twenty milliseconds worth of audio; this can vary due to differences in client settings.
To help keep track of the torrent of packets for each user, you can use user IDs in combination the synchronization value (SSRC) sent by Discord to determine the source of each packet.</p>
<p>This short-and-simple example will use <a href="https://ffmpeg.org/about.html">ffmpeg</a> to convert each packet to a <em>wav</em> file.</p>
<pre><code class="lang-cs">private async Task ReceiveHandler(VoiceNextConnection _, VoiceReceiveEventArgs args)
{
    var name = DateTimeOffset.Now.ToUnixTimeMilliseconds();
    var ffmpeg = Process.Start(new ProcessStartInfo
    {
        FileName = &quot;ffmpeg&quot;,
        Arguments = $@&quot;-ac 2 -f s16le -ar 48000 -i pipe:0 -ac 2 -ar 44100 {name}.wav&quot;,
        RedirectStandardInput = true
    });

    await ffmpeg.StandardInput.BaseStream.WriteAsync(args.PcmData);
}
</code></pre><p><br>
That&#39;s really all there is to it. Connect to a voice channel, hook an event, process the data as you see fit.</p>
<p><img src="/images/voicenext_receive_01.png" alt="Wav Files"></p>
<h2 id="example-commands">Example Commands</h2>
<pre><code class="lang-cs">[Command(&quot;start&quot;)]
public async Task StartCommand(CommandContext ctx, DiscordChannel channel = null)
{
    channel ??= ctx.Member.VoiceState?.Channel;
    var connection = await channel.ConnectAsync();

    Directory.CreateDirectory(&quot;Output&quot;);
    connection.VoiceReceived += VoiceReceiveHandler;
}


[Command(&quot;stop&quot;)]
public Task StopCommand(CommandContext ctx)
{
    var vnext = ctx.Client.GetVoiceNext();

    var connection = vnext.GetConnection(ctx.Guild);
    connection.VoiceReceived -= VoiceReceiveHandler;
    connection.Dispose();

    return Task.CompletedTask;
}

private async Task VoiceReceiveHandler(VoiceNextConnection connection, VoiceReceiveEventArgs args)
{
    var fileName = DateTimeOffset.Now.ToUnixTimeMilliseconds();
    var ffmpeg = Process.Start(new ProcessStartInfo
    {
        FileName = &quot;ffmpeg&quot;,
        Arguments = $@&quot;-ac 2 -f s16le -ar 48000 -i pipe:0 -ac 2 -ar 44100 Output/{fileName}.wav&quot;,
        RedirectStandardInput = true
    });

    await ffmpeg.StandardInput.BaseStream.WriteAsync(args.PcmData);
    ffmpeg.Dispose();
}
</code></pre></article>
              
                </div>
            </main>
        </div>

        
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<script type="text/javascript" src="../../../styles/jquery.twbsPagination.js"></script>
<script type="text/javascript" src="../../../styles/url.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>
<script type="text/javascript" src="../../../styles/docfx.js"></script>
<script type="text/javascript" src="../../../styles/main.js"></script>

    </body>

</html>
